---
title: "Anthropic公式の推奨するエージェントへのプロンプト設計"
emoji: "💭"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: [Claude code, anthropic, ai, agent, prompting]
published: false
---

毎朝YouTubeで適当な英語の技術に関する動画を視聴することを習慣化しています。今回は、最近見た中で特にためになる内容の動画を紹介します。

https://www.youtube.com/watch?v=1g0b8jv1nHk

動画のタイトルは「YouTube Prompting for Agents」で、Anthropicの研究者がエージェントに対するプロンプト設計について解説しています。AnthropicはAIの安全性と倫理性に注力している企業で、彼らの推奨するプロンプト設計は非常に参考になります。

## 1. エージェントとはなにか
Anthropicでは、エージェントを「ツールをループ内で使用するモデル」と定義しています。エージェントにはタスクが与えられ、ツール呼び出しから得られる情報に基づいて意思決定を更新し、タスクが完了するまで独立して作業を継続します。

## 2. エージェントを仕様すべきシナリオ
エージェントは常に必要とされるわけではなく、複雑で価値の高いタスクに最適です。 エージェントの導入を検討する際のチェックリストは以下の通りです:
• タスクは複雑か？: 人間が段階的なプロセスを明確に考えられないようなタスクで、最終的な目標は分かっているが、そこにどう到達するか、どのツールや情報が必要か不明な場合に有効です。
• タスクは価値があるか？: エージェントがタスクを達成することで大きな価値が得られる場合、例えば収益を生み出すような高レバレッジのタスクに適しています。
• タスクの各部分は実行可能か？: エージェントが必要とするツールを定義し、アクセスを提供できる場合に適しています。
• エラーのコストはどの程度か？: エラーの修正や検出が容易で、エラーが発生してもコストが高くない場合に、エージェントに独立して作業をさせることができます。エラーのコストが高い場合は、人間が介入する方が良いかもしれません。

### エージェントの優れたユースケースの例
• コーディング: 設計ドキュメントからプルリクエストを作成するなど、最終目標は明確だが、具体的な手順（何を最初に構築し、どう反復するか）が不明な複雑なタスク。これは高度なスキルを持つエンジニアの時間を節約する高価値なユースケースです。
• データ分析: 最終的なインサイトや視覚化の目標は分かっていても、データの具体的な形式、エラー、粒度などが不明な場合に有効です。
• 検索: エラーからの回復が比較的容易であるため、エージェントが独立して作業するのに適しています。
• コンピュータ操作: エラーが発生しても再試行などで回復できるため、エージェントに任せやすいです。

## 3.エージェントのためのプロンプト作成のベストプラクティス
Anthropicのチームがエージェント構築から学んだベストプラクティスは以下の通りです:

• **エージェントのように考える**: エージェントがその環境で何をしているのか、ツールの説明やスキーマを考慮して、エージェントの立場になって考えるメンタルモデルを開発することが最も重要です。人間がエージェントのすべきことを理解できない場合、AIも理解できません。

• **合理的なヒューリスティックを与える**: プロンプト作成は「概念工学」であり、モデルが持つべき概念と、特定の環境で適切に機能するための行動を決定することです。例えば、Claude Codeには「不可逆性」という概念を教え、ユーザーや環境に害を及ぼす可能性のある不可逆的な行動を避けるように指示します。また、不必要な検索を続けることを避けるために、「答えが見つかったら停止できる」といった明示的な指示や、クエリの複雑さに応じて「ツール呼び出しの予算」を設定するなどのヒューリスティックが有効です。

• **ツール選択は鍵**: モデルが多くのツールを扱えるようになっているため、どのタスクにどのツールを使用すべきかについて、明確な原則をエージェントに与えることが重要です。ツールの名前や説明が似ていると、モデルが混乱する可能性があるため、ツールは明確に区別し、類似のツールは結合するべきです。

• **思考プロセスをガイドする**: エージェントがその思考を効果的に使用するように促すことで、パフォーマンスをさらに向上させることができます。例えば、検索タスクでは、最初に「検索プロセスを計画する」ように指示し、クエリの複雑さ、使用するツール呼び出しの数、参照する情報源、成功の判断基準を決定させます。また、新しいCloud 4モデルは**ツール呼び出しの間に思考を挟む（interleaved thinking）**能力を持っており、検索結果の品質を吟味し、追加情報の必要性や免責事項の追加を判断するように促すことができます。

• **エージェントの予測不可能性と意図しない副作用**: エージェントは自律的にループ内で動作するため、ほとんどの変更には意図しない副作用が生じる可能性があります。例えば、「常に最高の品質のソースが見つかるまで検索を続ける」という指示は、そのようなソースが存在しない場合にエージェントが検索を停止しなくなる可能性があります。このような場合、「数回のツール呼び出しで停止してよい」といった制限を設ける必要があります。

• **コンテキストウィンドウの管理**: Claude 4モデルは200Kトークンのコンテキストウィンドウを持っていますが、長時間のタスクではこれを使い果たす可能性があります。
    ◦ 圧縮（Compaction）: Claude Codeでは、コンテキストウィンドウの限界に近づくと、これまでのすべてを要約して新しいClaudeインスタンスに渡すツールが自動的に呼び出されます。
    ◦ 外部ファイルへの書き込み: モデルが外部ファイルに記憶を書き込み、コンテキストウィンドウを拡張することができます。
    ◦ サブエージェントの使用: リードエージェントとサブエージェントからなるマルチエージェントシステムを構築し、サブエージェントが検索プロセスを実行し、結果を圧縮してリードエージェントに渡すことで、コンテキストウィンドウの使用量を削減できます。
• **ClaudeにClaudeらしくさせる**: Claudeはエージェントとしてすでに優れているため、まずは最小限のプロンプトとツールでシステムを試し、問題が発生した箇所から改善していくことが推奨されます。最初からClaudeの能力を過小評価しないようにしましょう。
• ツールの設計: 良いツールとは、シンプルで正確なツール名、明確な説明を持ち、動作がテストされているものです。


## 4. エージェントの評価 (Evals) の重要性と方法
評価は、プロンプトの進捗状況を体系的に測定するために非常に重要ですが、エージェントは長く実行され、予測不可能なプロセスを持つため、評価がより困難になります。

評価を簡単にするためのヒント:
**• 効果量が大きいほど、必要なサンプルサイズは小さい**: 最初に大規模な評価を設定しようとせず、ごく少数のテストケースで手動で開始することが推奨されます。
**• 現実的なタスクを使用する:** システムが実際に何を行うかを反映するタスクで評価することが重要です。
**• LLMを評価者として使用する:** エージェントの出力は多様な構造を持つ可能性があるため、ルーブリックを与えてLLMにエージェントの出力を評価させるのが非常に有効です。これは、出力のわずかなバリエーションにも対応できます。
**• 人間の評価:** 最終的には、システムが何をしているかを手動で確認し、トランスクリプトを分析し、システムを理解することが不可欠です。
評価の例:
**• 回答の正確性:** LLMを評価者として、エージェントの回答が正確かどうかを判断させます。
**• ツール使用の正確性:** エージェントが正しいツールを適切な回数使用したかを、プログラム的にトランスクリプトをチェックして評価します。
**• 最終状態の達成 (ToBench):** エージェントがプロセスの最後に到達すべき最終状態（例: データベースの更新、ファイルの変更）を評価します。

## 5. エージェント向けプロンプト構築の具体的なアプローチ
プロンプトの構築は、以下のような反復的なプロセスで行われます:
• シンプルに始めて反復する: まずは「ウェブをエージェント的に検索せよ」のような非常にシンプルなプロンプトから始め、Claudeがどう動作するかを確認します。
• エッジケースの特定とプロンプトへの追加: Claudeがうまく対応できないエッジケースや小さな欠陥が見つかったら、それらをプロンプトの指示や例として追加していきます。目標は、時間をかけて合格するテストケースの数を増やすことです。
• Few-shot学習の有効性: 従来のプロンプト手法でFew-shotの例を与えることは、最先端のモデルやエージェントにとっては、モデルの動作を制限しすぎる可能性があるため、あまり効果的ではないとされています。モデルはすでに「Chain of Thought」のような思考プロセスを学習しています。代わりに、モデルに「思考プロセスを使用して検索を計画せよ」のように、思考の使い方をガイドすることが有効です。また、例を与える場合でも、あまり規範的にならないようにすることが重要です。
